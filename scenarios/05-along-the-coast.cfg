#textdomain wesnoth-drusi

#define CAIRN_EFFECT_AREA
	x,y=11,10
	radius=2
#enddef

[scenario]
	id=along-the-coast
	next_scenario=dread-marsh

	name=Along the coast
	map_data="{~add-ons/DruidSiege/maps/coastline.map}"
	turns=30
	{EXPERIENCE_MOD}
	{DEFAULT_SCHEDULE}
	[music]
		name=frantic.ogg
        ms_before=12000
    [/music]
    [music]
    	name=vengeful.ogg
        ms_before=12000
        append=yes
    [/music]
    victory_music=elf-land.ogg
	[side]
		side=1
		{HERO_SIDE}
		recruit=Elvish Initiate
		gold=120
		income=2
		fog=no
		shroud=no
	[/side]
	[side]
		side=2
		controller=ai
		recruit=Goblin Spearman,Troll Whelp,Wolf Rider,Dwarvish Scout,Thief
		gold=120
		income=1
		color=brown
		current_player=_"Kalg"
		team_name=motley,darkness
		user_team_name=_"Misfits"
		{FLAG_VARIANT knalgan}
			id=kalg
			type=Troll Shaman
			name=_"Kalg"
			[modifications]
				{TRAIT_STRONG}
				{TRAIT_INTELLIGENT}
			[/modifications]
		[ai]
			recruitment_ignore_bad_combat=yes
			recruitment_ignore_bad_movement=yes
			[aspect]
				id=recruitment
				[facet]
					[value]
						name=ai_default::recruitment
						[limit]
							type=Dwarvish Scout
							max=4
						[/limit]
						[limit]
							type=Troll Whelp
							max=6
						[/limit]
					[/value]
				[/facet]
			[/aspect]
		[/ai]
	[/side]
	[side]
		side=3
		no_leader=yes
		controller=ai
		color=black
		current_player=_"Undead"
		team_name=darkness
		user_team_name=_"Undead"
		{FLAG_VARIANT undead}
		[ai]
			village_value=0
			aggression=0.2
			caution=0.1
			[avoid]
				{CAIRN_EFFECT_AREA}
			[/avoid]
		[/ai]
	[/side]
	[story]
		[part]
			show_title=yes
			[if]
				[variable]
					name=killedgragchak
					boolean_equals=yes
				[/variable]
				[then]
					story=_"After slaying the orc sovereign, the elves continued north along the coast until the drew near the fabled Dread Marsh..."
				[/then]
				[else]
					story=_"After a brief strategy meeting with Grag-Chak, the orc sovereign, he set out to muster more forces while they continued north along the coast until the drew near the fabled Dread Marsh..."
				[/else]
			[/if]
			background=aleron-map.png
			{OLD_BATTLE 270 314}
			{OLD_JOURNEY 288 298}
			{OLD_JOURNEY 295 287}
			{OLD_JOURNEY 318 277}
			{OLD_BATTLE 341 277}
			{OLD_JOURNEY 354 273}
			{OLD_JOURNEY 377 268}
			{OLD_BATTLE 396 262}
			{OLD_JOURNEY 383 253}
			{OLD_BATTLE 365 243}
			{NEW_JOURNEY 381 240}
			{NEW_JOURNEY 369 235}
			{NEW_JOURNEY 408 230}
			{NEW_JOURNEY 415 218}
			{NEW_JOURNEY 416 207}
			{NEW_BATTLE 413 190}
		[/part]
	[/story]
#ifdef DRUID_DEBUG
	{FORCE_CHANCE_TO_HIT side=2,3 side=1 10 ()}
	{FORCE_CHANCE_TO_HIT side=1 side=2,3 90 ()}
#endif
	{LIMIT_RECRUITS_FOREVER 1 (Elvish Fighter) 3}
	{LIMIT_RECRUITS_FOREVER 1 (Elvish Archer) 2}
	{LIMIT_RECRUITS_FOREVER 1 (Mermaid Initiate) 3}
	{LIMIT_RECRUITS_FOREVER 1 (Merman Hunter) 2}
	{PRELOAD_EVENT}
	{ENABLE_TROLL_SHAMAN}
	{HERO_DEATHS}
	
	[event]
		name=prestart
		[item]
			terrain=Mm
			image="scenery/mine-abandoned.png"
		[/item]
		[item]
			x,y=11,10
			image="scenery/rock-cairn.png"
			halo="halo/lighthouse-aura.png"
		[/item]
		[time_area]
			{CAIRN_EFFECT_AREA}
			{TWEAKED_DAWN holy 10 bright}
			{TWEAKED_MORNING holy 35 bright}
			{TWEAKED_AFTERNOON holy 35 bright}
			{TWEAKED_DUSK holy 10 bright}
			{TWEAKED_FIRST_WATCH holy -15 bright}
			{TWEAKED_SECOND_WATCH holy -15 bright}
		[/time_area]
		[tunnel]
			id=narrow_tunnels
			always_visible=yes
			[source]
				terrain=Mm
				[not]
					[filter]
						[not]
							id=$teleport_unit.id
						[/not]
					[/filter]
				[/not]
			[/source]
			[target]
				terrain=Mm
				[not]
					[filter]
						[not]
							id=$teleport_unit.id
						[/not]
					[/filter]
				[/not]
			[/target]
			[filter]
				race=dwarf
				[or]
					race=goblin
				[/or]
				[or]
					race=bats
				[/or]
				[or]
					type=Walking Corpse,Soulless
					[filter_wml]
						variation=bat
					[/filter_wml]
				[/or]
				[or]
					type=Walking Corpse,Soulless
					[filter_wml]
						variation=goblin
					[/filter_wml]
				[/or]
				[or]
					type=Walking Corpse,Soulless
					[filter_wml]
						variation=dwarf
					[/filter_wml]
				[/or]
			[/filter]
		[/tunnel]
		[objectives]
			[objective]
				description=_"Survive for 30 turns"
				show_turn_counter=yes
				condition=win
			[/objective]
			[objective]
				{BONUS_OBJECTIVE_CAPTION}
				description=_"Defeat enemy leader"+{EARLY_FINISH_BONUS_FOOTNOTE}
				condition=win
			[/objective]
			[objective]
				description=_"Death of Eärendil"
				condition=lose
			[/objective]
		[/objectives]
		[set_variable]
			name=turn_counter
			value=1
		[/set_variable]
		[recall]
			id=hermitsorceress
		[/recall]
		[recall]
			id=chiefguard
		[/recall]
		# Recall the aged captain for the end cutscene.
		# It's done now because for some reason attempting to do it
		# in the end cutscene causes the game to crash.
		[recall]
			id=agedcaptain
		[/recall]
	[/event]
	
	[event]
		name=start
		[message]
			speaker=chiefguard
			message=_"There is a small elf settlement just south of here. I will see whether I can muster any more aid for our cause there."
		[/message]
		[message]
			speaker=chiefdruid
			message=_"Very well, but hurry back. I think the undead are coming out of the swamp."
		[/message]
		[message]
			speaker=chiefguard
			message=_"As long as you can hold them off until I return, you should be fine."
		[/message]
		[move_unit]
			id=chiefguard
			to_x=40,39,39,39,39,39
			to_y=33,34,35,36,37,38
		[/move_unit]
		[store_unit]
			[filter]
				id=chiefguard
			[/filter]
			variable=save_erendor
			kill=yes
		[/store_unit]
		[recall]
			race=dwarf
		[/recall]
		[role]
			role=dwarfinformant
			type=Dwarvish Fighter,Dwarvish Steelclad,Dwarvish Lord,Dwarvish Runesmith, Dwarvish Runemaster,Dwarvish Arcanister,Dwarvish Berserker
		[/role]
		[if]
			[have_unit]
				role=dwarfinformant
			[/have_unit]
			[then]
				[recall]
					role=dwarfinformant
				[/recall]
				[message]
					role=dwarfinformant
					message=_"I used to come up here sometimes in my youth; the place is riddled with narrow tunnels. Most of you are probably too big to navigate them well, but dwarves, goblins, and bats should have no problem."
				[/message]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=new turn
		first_time_only=no
		[filter_condition]
			[variable]
				name=turn_counter
				numerical_equals=1
			[/variable]
		[/filter_condition]
		{SCATTER_UNITS 45 "Skeleton,Skeleton Archer,Walking Corpse" 3 (
			terrain=Ss,Sm,Wwf
			x=0-11
			y=6-34
			[not]
				[filter]
				[/filter]
			[/not]
			[not]
				{CAIRN_EFFECT_AREA}
			[/not]
		) side=3}
		{SCATTER_UNITS 10 "Vampire Bat,Walking Corpse" 3 (
			terrain=Ss,Sm,Wwf
			x=10-30
			y=20-40
			[not]
				[filter]
				[/filter]
			[/not]
			[not]
				{CAIRN_EFFECT_AREA}
			[/not]
		) side=3}
		{SCATTER_UNITS 1 "Wraith,Draug,Bone Shooter,Shadow,Chocobone" 3 (
			terrain=Ss,Sm,Wwf
			x=10-30
			y=20-40
			[not]
				[filter]
				[/filter]
			[/not]
			[not]
				{CAIRN_EFFECT_AREA}
			[/not]
		) side=3}
		[set_variable]
			name=turn_counter
			add=1
		[/set_variable]
#		{DEBUG_MSG "Spawning more undead!"}
		[event]
			id=increment_undead_counter
			name=new turn
			first_time_only=no
			[filter_condition]
				[not]
					[variable]
						name=turn_counter
						numerical_equals=1
					[/variable]
				[/not]
			[/filter_condition]
#			{DEBUG_MSG "Incrementing counter!"}
			[set_variable]
				name=turn_counter
				add=1
			[/set_variable]
			[if]
				[variable]
					name=turn_counter
					greater_than=6
				[/variable]
				[then]
#					{DEBUG_MSG "Resetting counter!"}
					[set_variable]
						name=turn_counter
						value=1
					[/set_variable]
				[/then]
			[/if]
		[/event]
	[/event]
	
	[event]
		name=time over
		[fire_event]
			name=end cutscene
		[/fire_event]
	[/event]
	
	[event]
		name=enemies defeated
		[role]
			role=outlawpleader
			side=2
		[/role]
		[message]
			role=outlawpleader
			message=_"Hey! If we show you the awesome magic orb in the vault, will you let us live?"
		[/message]
		[message]
			speaker=chiefdruid
			message=_"What does it do?"
		[/message]
		[message]
			role=outlawpleader
			message=_"I dunno! It's bright and powerful."
		[/message]
		[message]
			speaker=chiefdruid
			message=_"Very well, if you wish."
		[/message]
		[move_unit]
			role=outlawpleader
			to_x,to_y=11,9
		[/move_unit]
		[move_unit]
			id=chiefdruid
			to_x,to_y=10,9
		[/move_unit]
		{PLACE_IMAGE "items/ball-magenta.png" 11 10}
		[message]
			role=outlawpleader
			message=_"See? I think you use it like this..."
		[/message]
		[message]
			id=chiefdruid
			message=_"Uh, hold on a second..."
		[/message]
		# This part copied from Dead Water, the Flaming Sword scenario (Caladon's death)
        [sound]
            name={SOUND_LIST:HOLY}
        [/sound]
        [sound]
            name={SOUND_LIST:HOLY}
        [/sound]
        
        [kill]
        	side=3
            race=undead
        [/kill]

        {VARIABLE color 250}
        {VARIABLE delta 8}
        {REPEAT 14 (
            [set_variable]
                name=delta
                sub=3
            [/set_variable]

            [set_variable]
                name=color
                add=$delta
            [/set_variable]

            [color_adjust]
                red,green,blue=$color|,$color|,$color
            [/color_adjust]

            [delay]
                time=100
            [/delay]
        )}

        [color_adjust]
            red,green,blue=0,0,0
        [/color_adjust]
        # End copied (and tweaked) portion
		{REMOVE_IMAGE 11 10}
		{PLACE_IMAGE "scenery/rock-cairn.png" 11 10}
		[message]
			role=outlawpleader
			message=_"Uh... okay, that's not what I expected it to do. And it looks like it's broken. Sorry? Don't kill me?"
		[/message]
		[message]
			speaker=chiefdruid
			message=_"Don't worry; it seems to have destroyed all of the undead in the swamp outskirts, so we'll forgive you."
		[/message]
		[message]
			role=outlawpleader
			message=_"Thanks, elf lady! We won't bother you again!"
		[/message]
		[fire_event]
			name=end cutscene
		[/fire_event]
	[/event]
	
	[event]
		name=end cutscene
		[unstore_unit]
			variable=save_erendor
			x,y=15,33
		[/unstore_unit]
		{CLEAR_VARIABLE save_erendor}
		[unit]
			id=agedlord
			name=_"Hallen"
			type=Elvish Lord
			x,y=14,33
			{IS_HERO}
			{IS_SPECIAL}
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_DEXTROUS}
				{TRAIT_AGED}
			[/modifications]
		[/unit]
		[if]
			[have_unit]
				side=2
				canrecruit=yes
			[/have_unit]
			[then]
				[message]
					speaker=chiefguard
					message=_"I see you've held out nicely! We'll be able to mop up the rest of the undead quickly now, and then we can head into the swamp."
				[/message]
			[/then]
			[else]
				[message]
					speaker=chiefguard
					message=_"Wow, you've done quite well in my absence. I see not a single undead in the swamp. No matter, the reinforcements I brought will still be handy when we venture into the swamp."
				[/message]
			[/else]
		[/if]
		[if]
			[have_unit]
				id=agedcaptain
			[/have_unit]
			[then]
				[store_unit]
					variable=agedcaptain
					[filter]
						id=agedcaptain
					[/filter]
				[/store_unit]
				[message]
					speaker=agedcaptain
					message=_"Well met, Lord Hallen! It's been awhile!"
				[/message]
				[message]
					speaker=agedlord
					message=_"Is... is that $agedcaptain.name, my old friend? Well met indeed! It's been so long since we saw each other."
				[/message]
				[message]
					speaker=agedcaptain
					message=_"Aye, and you a lord now. Who would have thought?"
				[/message]
				[message]
					speaker=agedlord
					message=_"I know what you mean. But let's leave the catching up for later. We have undead to hunt."
				[/message]
				{CLEAR_VARIABLE agedcaptain}
			[/then]
		[/if]
		[message]
			speaker=agedlord
			message=_"Lady Eärendil, I place many of my citizens under your command for this venture. They are not extensively trained in combat, but they can wield a sword and bow, which should be enough."
		[/message]
		[message]
			speaker=chiefdruid
			message=_"Thank you, Lord Hallen. I will treat them as I would treat my own initiates."
		[/message]
		[allow_recruit]
			side=1
			type=Elvish Civilian
		[/allow_recruit]
		[if]
			[have_unit]
				side=2
				canrecruit=yes
			[/have_unit]
			[then]
				[endlevel]
					result=victory
					bonus=yes
					carryover_report=yes
					carryover_percentage=50
					carryover_add=yes
				[/endlevel]
			[/then]
			[else]
				[endlevel]
					result=victory
					bonus=yes
					carryover_report=yes
					carryover_percentage=30
					carryover_add=no
				[/endlevel]
			[/else]
		[/if]
	[/event]
	[event]
		name=moveto
		[filter]
			side=1
			[filter_location]
				x,y=46,2
			[/filter_location]
		[/filter]
		[message]
			speaker=unit
			message=_"This village shows signs of recent occupation, but I haven't seen anyone yet..."
		[/message]
		[unit]
			type=Drake Burner
			x,y=46,2
			id=firedrake
			{IS_LOYAL}
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_RESILIENT}
				{TRAIT_HARDY}
			[/modifications]
		[/unit]
		[unit]
			type=Drake Glider
			x,y=46,2
			id=skydrake
			{IS_LOYAL}
			[modifications]
				{TRAIT_LOYAL}
				{TRAIT_QUICK}
				{TRAIT_STRONG}
			[/modifications]
		[/unit]
		[message]
			speaker=firedrake
			message=_"Ahoy, stranger! What brings you here?"
		[/message]
		[message]
			speaker=unit
			message=_"We're battling undead over in the swamp."
		[/message]
		[message]
			speaker=skydrake
			message=_"Undead, eh? We've been meaning to do something about those. Every so often they get this far out and make a nuisance of themselves."
		[/message]
		[message]
			speaker=firedrake
			message=_"We'll come with you. You've found yourself an ally."
		[/message]
	[/event]
[/scenario]